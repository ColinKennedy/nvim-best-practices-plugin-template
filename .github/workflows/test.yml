# name: Test
#
# on:
#   pull_request:
#     types: [opened, synchronize, reopened, ready_for_review]
#     branches:
#     - main
#   push:
#     branches:
#       - main
#       # TODO: Remove this later
#       - add_windows_busted_support
#
# jobs:
#   test:
#     strategy:
#       matrix:
#         os: [windows-latest]
#         neovim: [v0.10.0]
#
#     runs-on: ${{ matrix.os }}
#     name: "OS: ${{ matrix.os }} - Neovim: ${{ matrix.neovim }}"
#
#     steps:
#     - uses: actions/checkout@master
#
#     - uses: ilammy/msvc-dev-cmd@v1
#     - uses: leafo/gh-actions-lua@v10
#       with:
#         # Neovim is compiled with LuaJIT so we might as well match. But it
#         # doesn't look like we can match it exactly.
#         #
#         # Reference:
#         #    https://github.com/leafo/gh-actions-lua/issues/49#issuecomment-2295071198
#         #
#         luaVersion: "5.1.3"
#
#     - uses: leafo/gh-actions-luarocks@v4
#
#     - uses: rhysd/action-setup-vim@v1
#       with:
#         neovim: true
#         version: ${{ matrix.neovim }}
#
#     - name: build
#       run: |
#         luarocks test plugin-template-scm-1.rockspec --prepare
#
#     - name: test
#       run: |
#         luarocks test --test-type busted

name: Test

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
    - main
  push:
    branches:
      - main
      # TODO: Remove this later
      - add_windows_busted_support

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        neovim: [v0.10.0]
        # TODO: Replace with -latest, later
        os: ["ubuntu-22.04", "macos-11", "windows-2022"]

    name: "OS: ${{ matrix.os }} - Neovim: ${{ matrix.neovim }}"
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup ’msvc’
      if: ${{ startsWith(matrix.os, 'windows') && !startsWith(matrix.luaVersion, 'luajit') }}
      uses: ilammy/msvc-dev-cmd@v1

    - name: Setup ‘lua’
      uses: leso-kn/gh-actions-lua@v11-staging
      with:
        # TODO: Replace with LuaJIT later
        luaVersion: "5.1.3"

    - name: Setup luarocks
      uses: hishamhm/gh-actions-luarocks@master

    - uses: rhysd/action-setup-vim@v1
      with:
        neovim: true
        version: ${{ matrix.neovim }}

    - name: Build Test-related Dependencies
      run: |
        luarocks test plugin-template-scm-1.rockspec --prepare

    - name: Test
      run: |
        luarocks test --test-type busted
